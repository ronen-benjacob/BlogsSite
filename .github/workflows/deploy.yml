name: Deploy to Local

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, master]

jobs:
  deploy:
    name: Deploy to Local Windows Machine
    runs-on: [self-hosted, Windows, local-deploy]
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment directory
        run: |
          if (!(Test-Path "C:\deployments\flask-blog")) {
            New-Item -Path "C:\deployments\flask-blog" -ItemType Directory -Force
            Write-Host "SUCCESS: Created deployment directory"
          } else {
            Write-Host "SUCCESS: Deployment directory already exists"
          }
        shell: powershell

      - name: Stop existing containers
        run: |
          cd C:\deployments\flask-blog
          if (Test-Path "docker-compose.prod.yml") {
            Write-Host "Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down
            Write-Host "SUCCESS: Containers stopped"
          } else {
            Write-Host "No existing deployment found"
          }
        shell: powershell
        continue-on-error: true

      - name: Copy application files
        run: |
          Write-Host "Copying application files..."
          Copy-Item -Path "${{ github.workspace }}\*" -Destination "C:\deployments\flask-blog\" -Recurse -Force -Exclude @('.git', '.github', '.venv', '__pycache__', '*.pyc', 'htmlcov', '.coverage')
          Write-Host "SUCCESS: Application files copied"
        shell: powershell

      - name: Create .env file from secrets
        run: |
          Write-Host "Creating .env file from GitHub Secrets..."
          $envContent = @"
            # Flask Configuration
            FLASK_KEY=${{ secrets.FLASK_KEY }}
            FLASK_ENV=production

            # Database Configuration
            POSTGRES_DB=blog_db_prod
            POSTGRES_USER=blog_user_prod
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

            # SQLAlchemy Connection String
            SQLALCHEMY_DATABASE_URI=postgresql://blog_user_prod:${{ secrets.POSTGRES_PASSWORD }}@db:5432/blog_db_prod

            # GitHub Configuration
            GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
          "@

          $envContent | Out-File -FilePath "C:\deployments\flask-blog\.env" -Encoding UTF8 -Force
          Write-Host "SUCCESS: .env file created successfully"
          Write-Host "Location: C:\deployments\flask-blog\.env"
        shell: powershell

      - name: Pull latest Docker image
        run: |
          cd C:\deployments\flask-blog
          Write-Host "Pulling latest Docker image..."

          # Try to pull image, if fails due to permissions, provide helpful error
          try {
            docker pull ghcr.io/${{ github.repository_owner }}/flask-blog:latest
            Write-Host "SUCCESS: Docker image pulled"
          } catch {
            Write-Host "WARNING: Could not pull image. Will use existing image or build will pull automatically."
          }
        shell: powershell
        continue-on-error: true

      - name: Verify Docker access
        run: |
          Write-Host "Verifying Docker access..."
          docker version
          docker ps
        shell: powershell

      - name: Start application
        run: |
          cd C:\deployments\flask-blog
          Write-Host "Starting application with docker-compose..."

          # Set Docker host to use TCP if named pipe fails
          $env:DOCKER_HOST = "tcp://localhost:2375"

          docker-compose -f docker-compose.prod.yml up -d
          Write-Host "SUCCESS: Application started"
        shell: powershell

      - name: Wait for application to start
        run: |
          Write-Host "Waiting for application to initialize..."
          Start-Sleep -Seconds 20
        shell: powershell

      - name: Check container status
        run: |
          cd C:\deployments\flask-blog
          Write-Host "Container Status:"
          docker-compose -f docker-compose.prod.yml ps
        shell: powershell

      - name: Verify deployment
        run: |
          Write-Host "Verifying deployment..."

          # Just check if containers are running
          cd C:\deployments\flask-blog
          $containers = docker-compose -f docker-compose.prod.yml ps --format json | ConvertFrom-Json

          $webRunning = $false
          $dbRunning = $false

          foreach ($container in $containers) {
            if ($container.Service -eq "web" -and $container.State -eq "running") {
              $webRunning = $true
              Write-Host "SUCCESS: Web container is running"
            }
            if ($container.Service -eq "db" -and $container.State -eq "running") {
              $dbRunning = $true
              Write-Host "SUCCESS: Database container is running"
            }
          }

          if ($webRunning -and $dbRunning) {
            Write-Host "SUCCESS: All containers are running!"
          } else {
            Write-Host "WARNING: Some containers may not be running"
            docker-compose -f docker-compose.prod.yml ps
          }

          Write-Host ""
          Write-Host "Note: Health check endpoint will be added in Day 5"
        shell: powershell
        continue-on-error: false

      - name: Deployment summary
        if: success()
        run: |
          Write-Host ""
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host "Deployment Successful!" -ForegroundColor Green
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Application Details:"
          Write-Host "   URL: http://localhost:5003"
          Write-Host "   Health: http://localhost:5003/health"
          Write-Host "   Metrics: http://localhost:5003/metrics"
          Write-Host ""
          Write-Host "Deployment Info:"
          Write-Host "   Path: C:\deployments\flask-blog"
          Write-Host "   Commit: ${{ github.sha }}"
          Write-Host "   Branch: ${{ github.ref_name }}"
          Write-Host "   Image: ghcr.io/${{ github.repository_owner }}/flask-blog:latest"
          Write-Host ""
          Write-Host "=========================================" -ForegroundColor Green
        shell: powershell

      - name: Show logs on failure
        if: failure()
        run: |
          Write-Host "Deployment failed. Showing logs..."
          cd C:\deployments\flask-blog
          docker-compose -f docker-compose.prod.yml logs --tail=100
        shell: powershell
        continue-on-error: true
